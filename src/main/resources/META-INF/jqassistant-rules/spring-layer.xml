<jqa:jqassistant-rules xmlns:jqa="http://www.buschmais.com/jqassistant/core/analysis/rules/schema/v1.1">
    
    <concept id="spring-layer:VirtualComponentDependency"> 
        <requiresConcept refId="spring-injection:Component"/>
        <description>Creates a DEPENDS_ON relation between Spring Components, which are connected through interfaces. Sets an attribute "virtual"</description>
        <cypher><![CDATA[
          MATCH
             (artifact:Artifact)-[:CONTAINS]->(abstractType:Type),
             (component:Spring:Component)-[:DEPENDS_ON]->(abstractType)<-[:IMPLEMENTS|EXTENDS*]-(otherComponent:Spring:Component)
          WHERE
            component <> otherComponent
          MERGE
            (component)-[d:DEPENDS_ON]->(otherComponent)
          SET
            d.virtual=true   
          RETURN
            component as Dependent, collect(distinct otherComponent) as Dependencies
      ]]></cypher>
    </concept>
    
     <constraint id="spring-layer:ControllerMustDependEitherOnServicesOrRepositories">
        <requiresConcept refId="spring-layer:VirtualComponentDependency"/>
        <description>A Controller references Repositories or a Services, never both.</description>
        <cypher><![CDATA[
            MATCH
              (controller:Spring:Controller)-[:DEPENDS_ON]->(service:Spring:Service),
              (controller:Spring:Controller)-[:DEPENDS_ON]->(repository:Spring:Repository)
            RETURN
              controller as Controller
        ]]></cypher>
    </constraint>
        
     <constraint id="spring-layer:ControllerMustNotDependOnRepositoryUsedByService">
        <requiresConcept refId="spring-layer:VirtualComponentDependency"/>
        <description>A Controller must not depend on a repository which is used by a service he depends on.</description>
        <cypher><![CDATA[
            MATCH
              (controller:Spring:Controller)-[:DEPENDS_ON]->(service:Spring:Service),
              (controller:Spring:Controller)-[:DEPENDS_ON]->(repository:Spring:Repository),
              (service:Spring:Service)-[:DEPENDS_ON]->(repository:Spring:Repository)
            RETURN
              controller as Controller
        ]]></cypher>
    </constraint>

</jqa:jqassistant-rules>